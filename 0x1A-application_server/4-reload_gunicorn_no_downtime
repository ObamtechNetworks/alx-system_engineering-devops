#!/usr/bin/env bash
# Bash script to gracefully start gunicorn

# Function to find the Gunicorn master PID
get_gunicorn_pid() {
  # Use ps to find processes with "gunicorn" in the command
  gunicorn_pids=$(ps auxf | grep gunicorn | awk '{print $2}')

  # Check if any Gunicorn processes are found
  if [[ -z "$gunicorn_pids" ]]; then
    echo "Error: No Gunicorn processes found!"
    exit 1
  fi

  # Assuming the first PID is the master (common scenario)
  Gunicorn_PID=${gunicorn_pids%% *}
}

# Call the function to get the PID
get_gunicorn_pid

# Send HUP signal for graceful reload
echo "Sending HUP signal to Gunicorn master process (PID: $Gunicorn_PID) for graceful reload..."
kill -HUP $Gunicorn_PID

echo "Reload process initiated. New requests will be handled by workers with the updated code."

# ps aux | pgrep gunicorn | grep -v grep | awk '{print $2}' | xargs kill -HUP
